#!/bin/bash

ICON_DIR="$HOME/.local/share/applications/icons"
DESKTOP_DIR="$HOME/.local/share/applications/"

# Function to list all web apps
list_web_apps() {
  WEB_APPS=()
  while IFS= read -r -d '' file; do
    if grep -q '^Exec=.*\(setsid uwsm-app\).*' "$file"; then
      WEB_APPS+=("$(basename "${file%.desktop}")")
    fi
  done < <(find "$DESKTOP_DIR" -name '*.desktop' -print0)
}

# If no arguments provided, interactive mode
if [ "$#" -eq 0 ]; then
  # List all available web apps
  list_web_apps

  if ((${#WEB_APPS[@]})); then
    # Sort and display web apps using gum for interactive selection
    IFS=$'\n' SORTED_WEB_APPS=($(sort <<<"${WEB_APPS[*]}"))
    unset IFS
    APP_NAMES_STRING=$(gum choose --no-limit --header "Select web app to remove..." --selected-prefix="âœ— " "${SORTED_WEB_APPS[@]}")

    # Convert newline-separated string to array
    APP_NAMES=()
    while IFS= read -r line; do
      [[ -n "$line" ]] && APP_NAMES+=("$line")
    done <<< "$APP_NAMES_STRING"
  else
    echo "No web apps found to remove."
    exit 1
  fi
else
  # Use array to preserve spaces in app names when passed as arguments
  APP_NAMES=("$@")
fi

# Ensure at least one app is selected or passed
if [[ ${#APP_NAMES[@]} -eq 0 ]]; then
  echo "Error: You must select at least one web app to remove."
  exit 1
fi

# Process each selected app
for APP_NAME in "${APP_NAMES[@]}"; do
  # Check if .desktop file exists before removing
  if [ -f "$DESKTOP_DIR/$APP_NAME.desktop" ]; then
    rm -f "$DESKTOP_DIR/$APP_NAME.desktop"
    echo "Removed $APP_NAME.desktop"
  else
    echo "Error: $APP_NAME.desktop not found."
  fi

  # Check if icon exists before removing
  if [ -f "$ICON_DIR/$APP_NAME.png" ]; then
    rm -f "$ICON_DIR/$APP_NAME.png"
    echo "Removed $APP_NAME icon."
  else
    echo "Error: $APP_NAME icon not found."
  fi
done
